{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="fas fa-plus-circle"></i> Create New Listing</h2>

<form id="listingForm">
    <!-- Photo Upload -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-camera"></i> Photos
        </div>
        <div class="card-body">
            <input type="file" class="form-control" id="photoInput" name="photos" multiple accept="image/*" capture="environment">
            <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
            <button type="button" class="btn btn-secondary mt-2" id="analyzeBtn" style="display:none;">
                <i class="fas fa-magic"></i> Analyze with AI
            </button>
        </div>
    </div>

    <!-- Listing Details -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-edit"></i> Details
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required maxlength="80">
                <small class="text-muted">Max 80 characters</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">Price ($) *</label>
                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Cost ($)</label>
                    <input type="number" class="form-control" id="cost" name="cost" step="0.01">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Condition</label>
                <select class="form-select" id="condition" name="condition">
                    <option value="new">New</option>
                    <option value="like_new">Like New</option>
                    <option value="excellent" selected>Excellent</option>
                    <option value="good">Good</option>
                    <option value="fair">Fair</option>
                    <option value="poor">Poor</option>
                </select>
            </div>

            <div class="row">
                <div class="col-4">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand">
                </div>
                <div class="col-4">
                    <label class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size">
                </div>
                <div class="col-4">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Shipping Cost ($)</label>
                <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" value="0">
                <small class="text-muted">0 for free shipping</small>
            </div>
        </div>
    </div>

    <!-- Inventory Management -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-white">
            <i class="fas fa-box"></i> Inventory Management
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Storage Location *
                </label>
                <input type="text" class="form-control form-control-lg" id="storage_location" name="storage_location" placeholder="B1, C2, Shelf-3, etc." required>
                <small class="text-muted">Where you'll put this item (so you can find it when it sells!)</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1">
                <small class="text-muted">1 for single items, >1 for multiples</small>
            </div>
        </div>
    </div>

    <!-- Platforms -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-share-alt"></i> Platforms
        </div>
        <div class="card-body">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ebay" name="platforms" value="ebay" checked>
                <label class="form-check-label" for="ebay">
                    <i class="fab fa-ebay"></i> eBay
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="mercari" name="platforms" value="mercari" checked>
                <label class="form-check-label" for="mercari">
                    Mercari
                </label>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-grid gap-2">
        <button type="button" class="btn btn-outline-secondary btn-lg" id="saveDraftBtn">
            <i class="fas fa-save"></i> Save as Draft
        </button>
        <button type="button" class="btn btn-primary btn-lg" id="postBtn">
            <i class="fas fa-rocket"></i> Post Now
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let uploadedPhotos = [];

// Photo upload handling
document.getElementById('photoInput').addEventListener('change', async function(e) {
    const files = e.target.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
        formData.append('photos', file);
    }

    showLoading();

    try {
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            uploadedPhotos = data.paths;

            // Show previews
            const previewDiv = document.getElementById('photoPreview');
            previewDiv.innerHTML = '';
            for (let i = 0; i < files.length; i++) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                img.className = 'photo-preview';
                previewDiv.appendChild(img);
            }

            document.getElementById('analyzeBtn').style.display = 'block';
            showAlert(`${data.count} photo(s) uploaded!`, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// AI Analysis
document.getElementById('analyzeBtn').addEventListener('click', async function() {
    showLoading();

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        const data = await response.json();

        if (data.success) {
            const analysis = data.analysis;

            // Fill form
            if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
            if (analysis.description) document.getElementById('description').value = analysis.description;
            if (analysis.brand) document.getElementById('brand').value = analysis.brand;
            if (analysis.size) document.getElementById('size').value = analysis.size;
            if (analysis.color) document.getElementById('color').value = analysis.color;
            if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
            if (analysis.condition) {
                const condition = analysis.condition.replace(' ', '_').toLowerCase();
                document.getElementById('condition').value = condition;
            }

            showAlert('AI analysis complete!', 'success');
        } else {
            showAlert(data.error, 'warning');
        }
    } catch (error) {
        showAlert('Analysis failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// Save Draft
document.getElementById('saveDraftBtn').addEventListener('click', async function() {
    if (uploadedPhotos.length === 0) {
        showAlert('Please upload photos first!', 'warning');
        return;
    }

    const formData = collectFormData();
    showLoading();

    try {
        const response = await fetch('/api/save-draft', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Draft saved successfully!', 'success');
            setTimeout(() => window.location.href = '/drafts', 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// Post Listing
document.getElementById('postBtn').addEventListener('click', async function() {
    if (uploadedPhotos.length === 0) {
        showAlert('Please upload photos first!', 'warning');
        return;
    }

    if (!confirm('Post this listing now?')) return;

    const formData = collectFormData();
    showLoading();

    try {
        const response = await fetch('/api/post-listing', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Listing posted successfully!', 'success');
            setTimeout(() => window.location.href = '/listings', 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Post failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

function collectFormData() {
    const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
        .map(cb => cb.value);

    return {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        storage_location: document.getElementById('storage_location').value,
        quantity: document.getElementById('quantity').value,
        platforms: platforms
    };
}
</script>
{% endblock %}
