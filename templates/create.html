{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
{% if is_guest %}
<div class="alert alert-success mb-4">
    <h5 class="alert-heading"><i class="fas fa-magic"></i> Try ResellGenie AI FREE!</h5>
    <p class="mb-0">Upload a photo and watch AI create your listing instantly. No sign-up required to test!</p>
</div>
{% endif %}

<h2 class="mb-4"><i class="fas fa-plus-circle"></i> Create New Listing</h2>

<form id="listingForm">
    <!-- Photo Upload -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-camera"></i> Photos
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-6">
                    <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('cameraInput').click()">
                        <i class="fas fa-camera"></i><br>Take Photo
                    </button>
                    <input type="file" class="d-none" id="cameraInput" name="photos" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('photoInput').click()">
                        <i class="fas fa-upload"></i><br>Upload Files
                    </button>
                    <input type="file" class="d-none" id="photoInput" name="photos" multiple accept="image/*" onchange="handlePhotoSelect(event)">
                </div>
            </div>
            <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
            <button type="button" class="btn btn-secondary mt-2" id="analyzeBtn" style="display:none;">
                <i class="fas fa-magic"></i> Analyze with AI
            </button>
        </div>
    </div>

    <!-- Listing Details -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-edit"></i> Details
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required maxlength="80">
                <small class="text-muted">Max 80 characters</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">Price ($) *</label>
                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Cost ($)</label>
                    <input type="number" class="form-control" id="cost" name="cost" step="0.01">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-6">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="condition" name="condition">
                        <option value="new">New</option>
                        <option value="like_new">Like New</option>
                        <option value="excellent" selected>Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Item Type</label>
                    <select class="form-select" id="item_type" name="item_type">
                        <option value="general" selected>General Item</option>
                        <option value="clothing">Clothing & Accessories</option>
                        <option value="electronics">Electronics</option>
                        <option value="trading_card">Trading Cards (TCG/Sports)</option>
                        <option value="collectible">Collectibles</option>
                        <option value="home_garden">Home & Garden</option>
                        <option value="toys_games">Toys & Games</option>
                        <option value="books_media">Books & Media</option>
                        <option value="jewelry">Jewelry & Watches</option>
                        <option value="antiques">Antiques & Vintage</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-4">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand">
                </div>
                <div class="col-4">
                    <label class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size">
                </div>
                <div class="col-4">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Shipping Cost ($)</label>
                <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" value="0">
                <small class="text-muted">0 for free shipping</small>
            </div>
        </div>
    </div>

    <!-- Inventory Management -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-white">
            <i class="fas fa-box"></i> Inventory Management
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Storage Location *
                </label>
                <input type="text" class="form-control form-control-lg" id="storage_location" name="storage_location" placeholder="B1, C2, Shelf-3, etc." required>
                <small class="text-muted">Where you'll put this item (so you can find it when it sells!)</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1">
                <small class="text-muted">1 for single items, >1 for multiples</small>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">SKU / Custom ID</label>
                    <input type="text" class="form-control" id="sku" name="sku" placeholder="Optional">
                </div>
                <div class="col-6">
                    <label class="form-label">UPC / Barcode</label>
                    <input type="text" class="form-control" id="upc" name="upc" placeholder="Optional">
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-grid gap-2">
        {% if is_guest %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> <strong>Try the AI for free!</strong> Sign up (free) to save your listings and track inventory.
        </div>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-user-plus"></i> Sign Up Free to Save Listing
        </a>
        <small class="text-muted text-center mt-2">
            You can test the AI photo analysis above without signing up!
        </small>
        {% else %}
        <button type="button" class="btn btn-success btn-lg" id="postNowBtn">
            <i class="fas fa-rocket"></i> Post Now (Make Active)
        </button>
        <button type="button" class="btn btn-outline-primary btn-lg" id="saveDraftBtn">
            <i class="fas fa-save"></i> Save as Draft
        </button>
        <small class="text-muted text-center mt-2">
            <strong>Post Now</strong> makes it active for selling. <strong>Save as Draft</strong> saves it for later.
        </small>
        {% endif %}
    </div>
</form>

<!-- Photo Editor Modal -->
<div id="photoEditorModal" class="photo-editor-modal">
    <div class="photo-editor-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-magic"></i> Edit Photo (FREE!)</h4>
            <button class="btn btn-outline-danger" onclick="closePhotoEditor()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>

        <div class="text-center mb-3">
            <img id="photoEditorImage" class="photo-editor-image" src="">
        </div>

        <div class="photo-editor-toolbar">
            <button class="btn btn-primary" onclick="enableCrop()">
                <i class="fas fa-crop"></i> Crop
            </button>
            <button class="btn btn-success" id="cropBtn" onclick="applyCrop()" style="display:none;">
                <i class="fas fa-check"></i> Apply Crop
            </button>
            <button class="btn btn-danger" id="cancelCropBtn" onclick="cancelCrop()" style="display:none;">
                <i class="fas fa-times"></i> Cancel Crop
            </button>
            <button class="btn btn-warning" onclick="removeBackground()">
                <i class="fas fa-magic"></i> Remove Background
            </button>
            <button class="btn btn-info" onclick="enlargePhoto()">
                <i class="fas fa-search-plus"></i> Enlarge (2x)
            </button>
            <button class="btn btn-secondary" onclick="resetPhoto()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>

        <div class="alert alert-info mt-3">
            <i class="fas fa-gift"></i> <strong>FREE Feature!</strong> Other apps charge $5-20/month for background removal. We give it to you free!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let uploadedPhotos = [];
let editingDraftId = {% if draft_id %}{{ draft_id }}{% else %}null{% endif %};
let editingListingUuid = null;

// Generic photo handling function for both camera and file upload
async function handlePhotoSelect(e) {
    const files = e.target.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
        formData.append('photos', file);
    }

    showLoading();

    try {
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Append to existing photos instead of replacing
            uploadedPhotos = uploadedPhotos.concat(data.paths);

            // Show previews (append to existing)
            const previewDiv = document.getElementById('photoPreview');
            for (let i = 0; i < files.length; i++) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                img.className = 'photo-preview';
                img.title = 'Click to edit photo';

                // Make photo clickable to open editor
                const photoIndex = uploadedPhotos.length - data.paths.length + i;
                img.onclick = function() {
                    openPhotoEditor(photoIndex, this.src);
                };

                previewDiv.appendChild(img);
            }

            document.getElementById('analyzeBtn').style.display = 'block';
            showAlert(`${data.count} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }

    // Reset input so same file can be selected again
    e.target.value = '';
}

// ========================================
// PHOTO EDITOR FUNCTIONS (FREE!)
// ========================================
let cropper = null;
let currentEditingPhotoIndex = null;
let currentEditingPhotoSrc = null;
let originalPhotoSrc = null;

async function openPhotoEditor(photoIndex, photoSrc) {
    currentEditingPhotoIndex = photoIndex;
    originalPhotoSrc = photoSrc;

    const modal = document.getElementById('photoEditorModal');
    const img = document.getElementById('photoEditorImage');

    // Convert blob URL to base64 data URL
    try {
        if (photoSrc.startsWith('blob:')) {
            // Fetch the blob and convert to base64
            const response = await fetch(photoSrc);
            const blob = await response.blob();

            // Convert blob to base64 using FileReader
            const reader = new FileReader();
            reader.onloadend = function() {
                currentEditingPhotoSrc = reader.result; // This is the base64 data URL
                img.src = currentEditingPhotoSrc;
            };
            reader.readAsDataURL(blob);
        } else {
            // Already a data URL or regular URL
            currentEditingPhotoSrc = photoSrc;
            img.src = photoSrc;
        }
    } catch (error) {
        console.error('Error converting image:', error);
        currentEditingPhotoSrc = photoSrc;
        img.src = photoSrc;
    }

    modal.classList.add('show');

    // Destroy existing cropper if any
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    // Reset buttons
    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('show');

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function enableCrop() {
    const img = document.getElementById('photoEditorImage');

    if (cropper) {
        cropper.destroy();
    }

    cropper = new Cropper(img, {
        aspectRatio: NaN, // Free aspect ratio
        viewMode: 1,
        responsive: true,
        autoCropArea: 0.8,
        background: false,
        ready: function() {
            showAlert('Drag to select crop area', 'info');
        }
    });

    // Show crop action buttons
    document.getElementById('cropBtn').style.display = 'inline-block';
    document.getElementById('cancelCropBtn').style.display = 'inline-block';
}

async function applyCrop() {
    if (!cropper) return;

    showLoading();

    try {
        const canvas = cropper.getCroppedCanvas();
        const croppedImage = canvas.toDataURL('image/png');

        // Get crop coordinates for API call
        const cropData = cropper.getData();

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'crop',
                crop: {
                    x: Math.round(cropData.x),
                    y: Math.round(cropData.y),
                    width: Math.round(cropData.width),
                    height: Math.round(cropData.height)
                }
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo cropped successfully!', 'success');

            // Cleanup cropper
            cropper.destroy();
            cropper = null;
            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        } else {
            showAlert('Crop failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Crop timed out. Please try again.', 'warning');
        } else {
            showAlert('Crop failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function cancelCrop() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

async function removeBackground() {
    if (!currentEditingPhotoSrc) return;

    showLoading();
    showAlert('Removing background... This may take 10-15 seconds', 'info');

    try {
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'remove-bg'
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Background removed! (FREE feature worth $5-20/mo)', 'success');
        } else {
            showAlert('Background removal failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Background removal timed out. The image may be too large. Try a smaller image or crop it first.', 'warning');
        } else {
            showAlert('Background removal failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

async function enlargePhoto() {
    if (!currentEditingPhotoSrc) return;

    showLoading();

    try {
        // Get current image dimensions
        const img = document.getElementById('photoEditorImage');
        const currentWidth = img.naturalWidth;
        const currentHeight = img.naturalHeight;

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 20000); // 20 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'resize',
                width: currentWidth * 2,
                height: currentHeight * 2
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo enlarged to 2x size!', 'success');
        } else {
            showAlert('Enlarge failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Enlarge timed out. The image may be too large.', 'warning');
        } else {
            showAlert('Enlarge failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function resetPhoto() {
    if (!originalPhotoSrc) return;

    const img = document.getElementById('photoEditorImage');
    img.src = originalPhotoSrc;
    currentEditingPhotoSrc = originalPhotoSrc;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = originalPhotoSrc;
    }

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    showAlert('Photo reset to original', 'info');
}

function updatePhotoAfterEdit(newImageData, newFilepath) {
    // Update the modal image
    const img = document.getElementById('photoEditorImage');
    img.src = newImageData;
    currentEditingPhotoSrc = newImageData;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = newImageData;
    }

    // Update the uploaded photos array with new filepath
    if (newFilepath) {
        uploadedPhotos[currentEditingPhotoIndex] = newFilepath;
    }
}

// ========================================
// AI Analysis
let detectedCardData = null; // Store card data if detected

document.getElementById('analyzeBtn').addEventListener('click', async function() {
    showLoading();

    try {
        // Try card analysis first
        const cardResponse = await fetch('/api/analyze-card', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            })
        });

        const cardData = await cardResponse.json();

        // Check if it's a card
        if (cardData.success && cardData.card_data && cardData.card_data.is_card) {
            // Store card data for later
            detectedCardData = cardData.card_data;

            // Show card detection banner
            showCardDetectionBanner(cardData.card_data);

            // Fill form with card data
            fillFormFromCardData(cardData.card_data);

            showAlert('Card detected and analyzed!', 'success');
        } else {
            // Not a card, do regular item analysis
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });

            const data = await response.json();

            if (data.success) {
                const analysis = data.analysis;

                // Fill form
                if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
                if (analysis.description) document.getElementById('description').value = analysis.description;
                if (analysis.brand) document.getElementById('brand').value = analysis.brand;
                if (analysis.size) document.getElementById('size').value = analysis.size;
                if (analysis.color) document.getElementById('color').value = analysis.color;
                if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
                if (analysis.condition) {
                    const condition = analysis.condition.replace(' ', '_').toLowerCase();
                    document.getElementById('condition').value = condition;
                }

                // Check for collectible items
                if (analysis.collectible) {
                    const confidence = analysis.collectible_confidence || 0;
                    const indicators = analysis.collectible_indicators || [];
                    const franchise = analysis.franchise || '';

                    let collectibleMsg = `ðŸŽ¯ <strong>COLLECTIBLE DETECTED!</strong><br>`;
                    collectibleMsg += `Confidence: ${(confidence * 100).toFixed(0)}%<br>`;

                    if (franchise) {
                        collectibleMsg += `Franchise: ${franchise}<br>`;
                    }

                    if (indicators.length > 0) {
                        collectibleMsg += `Indicators: ${indicators.join(', ')}`;
                    }

                    // Create custom alert div
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
                    alertDiv.style.cssText = 'position: sticky; top: 10px; z-index: 1000; border: 3px solid #ff6b6b;';
                    alertDiv.innerHTML = `
                        ${collectibleMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    // Insert after form
                    document.getElementById('listingForm').insertAdjacentElement('beforebegin', alertDiv);

                    // Auto-set item type to collectible
                    document.getElementById('item_type').value = 'collectible';
                }

                // Show market analysis (sell-through rate)
                if (analysis.market_analysis) {
                    const market = analysis.market_analysis;
                    let demandColor = market.demand_level === 'High' ? 'success' :
                                     market.demand_level === 'Low' ? 'danger' : 'warning';

                    let marketMsg = `ðŸ“Š <strong>MARKET ANALYSIS</strong><br>`;
                    marketMsg += `<strong>Sell-Through Rate:</strong> ${market.sell_through_rate}% ${getDemandEmoji(market.demand_level)}<br>`;
                    marketMsg += `<strong>Demand:</strong> <span class="badge bg-${demandColor}">${market.demand_level}</span><br>`;
                    marketMsg += `<strong>Est. Days to Sell:</strong> ${market.days_to_sell_estimate} days<br>`;
                    if (market.average_sold_price > 0) {
                        marketMsg += `<strong>Avg Sold Price:</strong> $${market.average_sold_price.toFixed(2)}<br>`;
                    }
                    if (market.market_insights && market.market_insights.length > 0) {
                        marketMsg += `<small class="text-muted">${market.market_insights.join(' â€¢ ')}</small>`;
                    }

                    const marketAlert = document.createElement('div');
                    marketAlert.className = 'alert alert-info alert-dismissible fade show mt-3';
                    marketAlert.innerHTML = `
                        ${marketMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    document.getElementById('listingForm').insertAdjacentElement('beforebegin', marketAlert);
                }

                showAlert('AI analysis complete!', 'success');
            } else {
                showAlert(data.error, 'warning');
            }
        }
    } catch (error) {
        showAlert('Analysis failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

function getDemandEmoji(demand) {
    if (demand === 'High') return 'ðŸ”¥';
    if (demand === 'Low') return 'ðŸŒ';
    return 'ðŸ“ˆ';
}

// ========================================
// CARD COLLECTION FUNCTIONS
// ========================================

function showCardDetectionBanner(cardData) {
    // Remove any existing banner
    const existingBanner = document.getElementById('cardDetectionBanner');
    if (existingBanner) {
        existingBanner.remove();
    }

    // Build card info display
    let cardType = cardData.card_type || 'unknown';
    let cardName = cardData.card_name || cardData.player_name || 'Unknown Card';
    let cardDetails = [];

    // Add type-specific details
    if (cardData.player_name) {
        // Sports card
        if (cardData.year) cardDetails.push(`${cardData.year}`);
        if (cardData.brand) cardDetails.push(cardData.brand);
        if (cardData.is_rookie_card) cardDetails.push('RC');
    } else {
        // TCG card
        if (cardData.set_name) cardDetails.push(cardData.set_name);
        if (cardData.card_number) cardDetails.push(`#${cardData.card_number}`);
        if (cardData.rarity) cardDetails.push(cardData.rarity);
    }

    // Grading info
    if (cardData.is_graded && cardData.grading_company) {
        cardDetails.push(`${cardData.grading_company} ${cardData.grading_score || ''}`);
    }

    // Value estimate
    let valueText = '';
    if (cardData.estimated_value_low || cardData.estimated_value_high) {
        const low = cardData.estimated_value_low || 0;
        const high = cardData.estimated_value_high || 0;
        if (low > 0 && high > 0) {
            valueText = `<strong>Est. Value:</strong> $${low} - $${high}`;
        } else if (low > 0) {
            valueText = `<strong>Est. Value:</strong> $${low}+`;
        }
    }

    const cardInfo = cardDetails.join(' â€¢ ');
    const confidence = cardData.confidence ? `${(cardData.confidence * 100).toFixed(0)}%` : 'N/A';

    const banner = document.createElement('div');
    banner.id = 'cardDetectionBanner';
    banner.className = 'alert alert-success alert-dismissible fade show mt-3';
    banner.style.cssText = 'position: sticky; top: 10px; z-index: 1000; border: 3px solid #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);';
    banner.innerHTML = `
        <div>
            <h5 class="alert-heading mb-3">
                <i class="fas fa-id-card"></i> <strong>TRADING CARD DETECTED!</strong>
            </h5>
            <div class="row">
                <div class="col-md-7">
                    <p class="mb-2">
                        <strong>${cardName}</strong><br>
                        <small class="text-muted">${cardInfo}</small>
                    </p>
                    ${valueText ? `<p class="mb-2">${valueText}</p>` : ''}
                    <small class="text-muted">Confidence: ${confidence}</small>
                </div>
                <div class="col-md-5">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-success btn-lg pulse-glow" onclick="storeCardOnly()">
                            <i class="fas fa-box"></i> Store Only
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="storeAndList()">
                            <i class="fas fa-plus-circle"></i> Store + Create Listing
                        </button>
                        <small class="text-muted text-center">
                            Or just create a listing below without storing
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.getElementById('listingForm').insertAdjacentElement('beforebegin', banner);
}

function fillFormFromCardData(cardData) {
    // Build title
    let title = '';
    if (cardData.player_name) {
        // Sports card
        title = cardData.player_name;
        if (cardData.year) title = `${cardData.year} ${title}`;
        if (cardData.brand) title = `${title} ${cardData.brand}`;
        if (cardData.series) title = `${title} ${cardData.series}`;
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
        if (cardData.is_rookie_card) title = `${title} RC`;
    } else {
        // TCG card
        title = cardData.card_name || 'Unknown Card';
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
    }

    document.getElementById('title').value = title;

    // Build description
    let description = '';
    if (cardData.set_name) {
        description += `Set: ${cardData.set_name}\n`;
    }
    if (cardData.rarity) {
        description += `Rarity: ${cardData.rarity}\n`;
    }
    if (cardData.is_graded && cardData.grading_company) {
        description += `Graded: ${cardData.grading_company} ${cardData.grading_score || ''}\n`;
    }
    if (cardData.parallel) {
        description += `Parallel: ${cardData.parallel}\n`;
    }

    document.getElementById('description').value = description;

    // Set brand
    if (cardData.brand) {
        document.getElementById('brand').value = cardData.brand;
    }

    // Set price from estimated value
    if (cardData.estimated_value_low && cardData.estimated_value_high) {
        const avgValue = (cardData.estimated_value_low + cardData.estimated_value_high) / 2;
        document.getElementById('price').value = avgValue.toFixed(2);
    } else if (cardData.estimated_value_low) {
        document.getElementById('price').value = cardData.estimated_value_low.toFixed(2);
    }

    // Set item type to trading card
    document.getElementById('item_type').value = 'trading_card';

    // Set condition based on grading
    if (cardData.is_graded && cardData.grading_score) {
        if (cardData.grading_score >= 9) {
            document.getElementById('condition').value = 'excellent';
        } else if (cardData.grading_score >= 7) {
            document.getElementById('condition').value = 'good';
        } else {
            document.getElementById('condition').value = 'fair';
        }
    }
}

async function storeCardOnly() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card stored in your collection! Redirecting...', 'success');
            // Redirect to cards collection page after 1 second
            setTimeout(() => window.location.href = '/cards', 1000);
        } else {
            showAlert(data.error || 'Failed to add card to collection', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
        hideLoading();
    }
}

async function storeAndList() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card added to collection! You can now create a listing below.', 'success');

            // Update the banner to show it's been stored
            const banner = document.getElementById('cardDetectionBanner');
            if (banner) {
                banner.classList.remove('alert-success');
                banner.classList.add('alert-info');
                banner.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="alert-heading mb-0">
                                <i class="fas fa-check-circle"></i> <strong>Card Stored!</strong>
                            </h5>
                            <small class="text-muted">Continue filling out the form below to create a listing.</small>
                        </div>
                        <a href="/cards" class="btn btn-info">
                            <i class="fas fa-box-open"></i> View Collection
                        </a>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            }
        } else {
            showAlert(data.error || 'Failed to add card to collection', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Save Listing (common function)
async function saveListing(status = 'draft') {
    if (uploadedPhotos.length === 0) {
        showAlert('Please upload photos first!', 'warning');
        return;
    }

    const formData = collectFormData();
    formData.status = status;
    showLoading();

    try {
        const response = await fetch('/api/save-draft', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            const msg = status === 'active' ? 'Listing posted successfully!' : 'Listing saved as draft!';
            const redirect = status === 'active' ? '/listings' : '/drafts';
            showAlert(msg, 'success');
            setTimeout(() => window.location.href = redirect, 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Save as Draft button
document.getElementById('saveDraftBtn').addEventListener('click', async function() {
    await saveListing('draft');
});

// Post Now button
document.getElementById('postNowBtn').addEventListener('click', async function() {
    await saveListing('active');
});

function collectFormData() {
    const data = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        item_type: document.getElementById('item_type').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        storage_location: document.getElementById('storage_location').value,
        quantity: document.getElementById('quantity').value,
        sku: document.getElementById('sku').value,
        upc: document.getElementById('upc').value
    };

    // Include draft_id if editing
    if (editingDraftId) {
        data.draft_id = editingDraftId;
        data.listing_uuid = editingListingUuid;
    }

    return data;
}

// Load draft data for editing
async function loadDraftData() {
    if (!editingDraftId) return;

    showLoading();

    try {
        const response = await fetch(`/api/get-draft/${editingDraftId}`);

        // Check if response is OK before parsing JSON
        if (!response.ok) {
            hideLoading();
            showAlert(`Failed to load draft: Server returned ${response.status}`, 'danger');
            return;
        }

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            hideLoading();
            showAlert('Failed to load draft: Invalid response format', 'danger');
            return;
        }

        const data = await response.json();

        if (data.success) {
            const listing = data.listing;
            editingListingUuid = listing.listing_uuid;

            // Populate form fields
            document.getElementById('title').value = listing.title || '';
            document.getElementById('description').value = listing.description || '';
            document.getElementById('price').value = listing.price || '';
            document.getElementById('cost').value = listing.cost || '';
            document.getElementById('condition').value = listing.condition || 'good';
            document.getElementById('item_type').value = listing.item_type || 'general';
            document.getElementById('brand').value = listing.brand || '';
            document.getElementById('size').value = listing.size || '';
            document.getElementById('color').value = listing.color || '';
            document.getElementById('shipping_cost').value = listing.shipping_cost || 0;
            document.getElementById('storage_location').value = listing.storage_location || '';
            document.getElementById('quantity').value = listing.quantity || 1;
            document.getElementById('sku').value = listing.sku || '';
            document.getElementById('upc').value = listing.upc || '';

            // Load photos
            if (listing.photos && listing.photos.length > 0) {
                uploadedPhotos = listing.photos;

                // Display photo previews
                const previewDiv = document.getElementById('photoPreview');
                previewDiv.innerHTML = '';

                for (let i = 0; i < listing.photos.length; i++) {
                    const photoPath = listing.photos[i];
                    const img = document.createElement('img');
                    // Convert server path to URL
                    img.src = '/' + photoPath;
                    img.className = 'photo-preview';
                    img.title = 'Click to edit photo';

                    // Make photo clickable to open editor
                    const photoIndex = i;
                    img.onclick = function() {
                        openPhotoEditor(photoIndex, this.src);
                    };

                    img.onerror = function() {
                        // Fallback: try different path formats
                        this.src = '/data/draft_photos/' + listing.listing_uuid + '/' + photoPath.split('/').pop();
                    };
                    previewDiv.appendChild(img);
                }

                document.getElementById('analyzeBtn').style.display = 'block';
            }

            showAlert('Draft loaded for editing', 'info');
        } else {
            showAlert(data.error || 'Failed to load draft', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load draft: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Load draft data when page loads
if (editingDraftId) {
    document.addEventListener('DOMContentLoaded', loadDraftData);
}
</script>
{% endblock %}
