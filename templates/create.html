{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
{% if is_guest %}
<div class="alert alert-success mb-4">
    <h5 class="alert-heading"><i class="fas fa-magic"></i> Try ResellGenie AI FREE!</h5>
    <p class="mb-0">Upload a photo and watch AI create your listing instantly. No sign-up required to test!</p>
</div>
{% endif %}

<h2 class="mb-4"><i class="fas fa-plus-circle"></i> Create New Listing</h2>

<form id="listingForm">
    <!-- Photo Upload -->
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-camera"></i> Photos
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-6">
                    <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('cameraInput').click()">
                        <i class="fas fa-camera"></i><br>Take Photo
                    </button>
                    <input type="file" class="d-none" id="cameraInput" name="photos" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('photoInput').click()">
                        <i class="fas fa-upload"></i><br>Upload Files
                    </button>
                    <input type="file" class="d-none" id="photoInput" name="photos" multiple accept="image/*" onchange="handlePhotoSelect(event)">
                </div>
            </div>
            <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
            <button type="button" class="btn btn-secondary mt-2" id="analyzeBtn" style="display:none;">
                <i class="fas fa-magic"></i> Analyze with AI
            </button>
        </div>
    </div>

    <!-- Listing Details -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-edit"></i> Details
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required maxlength="80">
                <small class="text-muted">Max 80 characters</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">Price ($) *</label>
                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Cost ($)</label>
                    <input type="number" class="form-control" id="cost" name="cost" step="0.01">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-6">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="condition" name="condition">
                        <option value="new">New</option>
                        <option value="like_new">Like New</option>
                        <option value="excellent" selected>Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Item Type</label>
                    <select class="form-select" id="item_type" name="item_type">
                        <option value="general" selected>General Item</option>
                        <option value="clothing">Clothing & Accessories</option>
                        <option value="electronics">Electronics</option>
                        <option value="trading_card">Trading Cards (TCG/Sports)</option>
                        <option value="collectible">Collectibles</option>
                        <option value="home_garden">Home & Garden</option>
                        <option value="toys_games">Toys & Games</option>
                        <option value="books_media">Books & Media</option>
                        <option value="jewelry">Jewelry & Watches</option>
                        <option value="antiques">Antiques & Vintage</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-4">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand">
                </div>
                <div class="col-4">
                    <label class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size">
                </div>
                <div class="col-4">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Shipping Cost ($)</label>
                <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" value="0">
                <small class="text-muted">0 for free shipping</small>
            </div>
        </div>
    </div>

    <!-- Inventory Management -->
    <div class="card mb-3">
        <div class="card-header bg-warning text-white">
            <i class="fas fa-box"></i> Inventory Management
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Storage Location *
                </label>
                <input type="text" class="form-control form-control-lg" id="storage_location" name="storage_location" placeholder="B1, C2, Shelf-3, etc." required>
                <small class="text-muted">Where you'll put this item (so you can find it when it sells!)</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1">
                <small class="text-muted">1 for single items, >1 for multiples</small>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">SKU / Custom ID</label>
                    <input type="text" class="form-control" id="sku" name="sku" placeholder="Optional">
                </div>
                <div class="col-6">
                    <label class="form-label">UPC / Barcode</label>
                    <input type="text" class="form-control" id="upc" name="upc" placeholder="Optional">
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-grid gap-2">
        {% if is_guest %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> <strong>Try the AI for free!</strong> Sign up (free) to save your listings and track inventory.
        </div>
        <a href="{{ url_for('register') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-user-plus"></i> Sign Up Free to Save Listing
        </a>
        <small class="text-muted text-center mt-2">
            You can test the AI photo analysis above without signing up!
        </small>
        {% else %}
        <button type="button" class="btn btn-success btn-lg" id="postNowBtn">
            <i class="fas fa-rocket"></i> Post Now (Make Active)
        </button>
        <button type="button" class="btn btn-outline-primary btn-lg" id="saveDraftBtn">
            <i class="fas fa-save"></i> Save as Draft
        </button>
        <small class="text-muted text-center mt-2">
            <strong>Post Now</strong> makes it active for selling. <strong>Save as Draft</strong> saves it for later.
        </small>
        {% endif %}
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
let uploadedPhotos = [];
let editingDraftId = {{ draft_id if draft_id else 'null' }};
let editingListingUuid = null;

// Generic photo handling function for both camera and file upload
async function handlePhotoSelect(e) {
    const files = e.target.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
        formData.append('photos', file);
    }

    showLoading();

    try {
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Append to existing photos instead of replacing
            uploadedPhotos = uploadedPhotos.concat(data.paths);

            // Show previews (append to existing)
            const previewDiv = document.getElementById('photoPreview');
            for (let i = 0; i < files.length; i++) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                img.className = 'photo-preview';
                previewDiv.appendChild(img);
            }

            document.getElementById('analyzeBtn').style.display = 'block';
            showAlert(`${data.count} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }

    // Reset input so same file can be selected again
    e.target.value = '';
}

// AI Analysis
document.getElementById('analyzeBtn').addEventListener('click', async function() {
    showLoading();

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        const data = await response.json();

        if (data.success) {
            const analysis = data.analysis;

            // Fill form
            if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
            if (analysis.description) document.getElementById('description').value = analysis.description;
            if (analysis.brand) document.getElementById('brand').value = analysis.brand;
            if (analysis.size) document.getElementById('size').value = analysis.size;
            if (analysis.color) document.getElementById('color').value = analysis.color;
            if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
            if (analysis.condition) {
                const condition = analysis.condition.replace(' ', '_').toLowerCase();
                document.getElementById('condition').value = condition;
            }

            // Check for collectible items
            if (analysis.collectible) {
                const confidence = analysis.collectible_confidence || 0;
                const indicators = analysis.collectible_indicators || [];
                const franchise = analysis.franchise || '';

                let collectibleMsg = `ðŸŽ¯ <strong>COLLECTIBLE DETECTED!</strong><br>`;
                collectibleMsg += `Confidence: ${(confidence * 100).toFixed(0)}%<br>`;

                if (franchise) {
                    collectibleMsg += `Franchise: ${franchise}<br>`;
                }

                if (indicators.length > 0) {
                    collectibleMsg += `Indicators: ${indicators.join(', ')}`;
                }

                // Create custom alert div
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
                alertDiv.style.cssText = 'position: sticky; top: 10px; z-index: 1000; border: 3px solid #ff6b6b;';
                alertDiv.innerHTML = `
                    ${collectibleMsg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert after form
                document.getElementById('listingForm').insertAdjacentElement('beforebegin', alertDiv);

                // Auto-set item type to collectible
                document.getElementById('item_type').value = 'collectible';
            }

            // Show market analysis (sell-through rate)
            if (analysis.market_analysis) {
                const market = analysis.market_analysis;
                let demandColor = market.demand_level === 'High' ? 'success' :
                                 market.demand_level === 'Low' ? 'danger' : 'warning';

                let marketMsg = `ðŸ“Š <strong>MARKET ANALYSIS</strong><br>`;
                marketMsg += `<strong>Sell-Through Rate:</strong> ${market.sell_through_rate}% ${getDemandEmoji(market.demand_level)}<br>`;
                marketMsg += `<strong>Demand:</strong> <span class="badge bg-${demandColor}">${market.demand_level}</span><br>`;
                marketMsg += `<strong>Est. Days to Sell:</strong> ${market.days_to_sell_estimate} days<br>`;
                if (market.average_sold_price > 0) {
                    marketMsg += `<strong>Avg Sold Price:</strong> $${market.average_sold_price.toFixed(2)}<br>`;
                }
                if (market.market_insights && market.market_insights.length > 0) {
                    marketMsg += `<small class="text-muted">${market.market_insights.join(' â€¢ ')}</small>`;
                }

                const marketAlert = document.createElement('div');
                marketAlert.className = 'alert alert-info alert-dismissible fade show mt-3';
                marketAlert.innerHTML = `
                    ${marketMsg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.getElementById('listingForm').insertAdjacentElement('beforebegin', marketAlert);
            }

            showAlert('AI analysis complete!', 'success');
        } else {
            showAlert(data.error, 'warning');
        }
    } catch (error) {
        showAlert('Analysis failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

function getDemandEmoji(demand) {
    if (demand === 'High') return 'ðŸ”¥';
    if (demand === 'Low') return 'ðŸŒ';
    return 'ðŸ“ˆ';
}

// Save Listing (common function)
async function saveListing(status = 'draft') {
    if (uploadedPhotos.length === 0) {
        showAlert('Please upload photos first!', 'warning');
        return;
    }

    const formData = collectFormData();
    formData.status = status;
    showLoading();

    try {
        const response = await fetch('/api/save-draft', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            const msg = status === 'active' ? 'Listing posted successfully!' : 'Listing saved as draft!';
            const redirect = status === 'active' ? '/listings' : '/drafts';
            showAlert(msg, 'success');
            setTimeout(() => window.location.href = redirect, 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Save as Draft button
document.getElementById('saveDraftBtn').addEventListener('click', async function() {
    await saveListing('draft');
});

// Post Now button
document.getElementById('postNowBtn').addEventListener('click', async function() {
    await saveListing('active');
});

function collectFormData() {
    const data = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        item_type: document.getElementById('item_type').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        storage_location: document.getElementById('storage_location').value,
        quantity: document.getElementById('quantity').value,
        sku: document.getElementById('sku').value,
        upc: document.getElementById('upc').value
    };

    // Include draft_id if editing
    if (editingDraftId) {
        data.draft_id = editingDraftId;
        data.listing_uuid = editingListingUuid;
    }

    return data;
}

// Load draft data for editing
async function loadDraftData() {
    if (!editingDraftId) return;

    showLoading();

    try {
        const response = await fetch(`/api/get-draft/${editingDraftId}`);
        const data = await response.json();

        if (data.success) {
            const listing = data.listing;
            editingListingUuid = listing.listing_uuid;

            // Populate form fields
            document.getElementById('title').value = listing.title || '';
            document.getElementById('description').value = listing.description || '';
            document.getElementById('price').value = listing.price || '';
            document.getElementById('cost').value = listing.cost || '';
            document.getElementById('condition').value = listing.condition || 'good';
            document.getElementById('item_type').value = listing.item_type || 'general';
            document.getElementById('brand').value = listing.brand || '';
            document.getElementById('size').value = listing.size || '';
            document.getElementById('color').value = listing.color || '';
            document.getElementById('shipping_cost').value = listing.shipping_cost || 0;
            document.getElementById('storage_location').value = listing.storage_location || '';
            document.getElementById('quantity').value = listing.quantity || 1;
            document.getElementById('sku').value = listing.sku || '';
            document.getElementById('upc').value = listing.upc || '';

            // Load photos
            if (listing.photos && listing.photos.length > 0) {
                uploadedPhotos = listing.photos;

                // Display photo previews
                const previewDiv = document.getElementById('photoPreview');
                previewDiv.innerHTML = '';

                for (let photoPath of listing.photos) {
                    const img = document.createElement('img');
                    // Convert server path to URL
                    img.src = '/' + photoPath;
                    img.className = 'photo-preview';
                    img.onerror = function() {
                        // Fallback: try different path formats
                        this.src = '/data/draft_photos/' + listing.listing_uuid + '/' + photoPath.split('/').pop();
                    };
                    previewDiv.appendChild(img);
                }

                document.getElementById('analyzeBtn').style.display = 'block';
            }

            showAlert('Draft loaded for editing', 'info');
        } else {
            showAlert(data.error || 'Failed to load draft', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load draft: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Load draft data when page loads
if (editingDraftId) {
    document.addEventListener('DOMContentLoaded', loadDraftData);
}
</script>
{% endblock %}
