<!-- Platform Status Indicators Component -->
<style>
    .platform-indicators {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .platform-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .platform-badge:hover {
        transform: scale(1.05);
    }

    .platform-badge.active {
        background: #4CAF50;
        color: white;
    }

    .platform-badge.draft {
        background: #FFC107;
        color: #333;
    }

    .platform-badge.inactive {
        background: #e0e0e0;
        color: #666;
    }

    .platform-badge.error {
        background: #f44336;
        color: white;
    }

    .platform-status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: currentColor;
    }

    .platform-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .platform-modal.active {
        display: flex;
    }

    .platform-modal-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
    }

    .platform-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .platform-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
    }

    .platform-list-item:last-child {
        border-bottom: none;
    }

    .platform-actions {
        display: flex;
        gap: 8px;
    }

    .btn-sm {
        padding: 4px 12px;
        font-size: 0.85em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-publish {
        background: #2196F3;
        color: white;
    }

    .btn-delist {
        background: #f44336;
        color: white;
    }
</style>

<script>
// Platform status management
function loadPlatformStatus(listingId, containerId) {
    fetch(`/api/listing/${listingId}/platforms`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPlatformBadges(data.platforms, containerId, listingId);
            }
        })
        .catch(error => console.error('Error loading platform status:', error));
}

function renderPlatformBadges(platforms, containerId, listingId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    container.innerHTML = '';

    platforms.forEach(platform => {
        const badge = document.createElement('span');
        badge.className = `platform-badge ${platform.status}`;
        badge.title = `${platform.name}: ${platform.status}`;
        badge.onclick = () => showPlatformModal(listingId);

        badge.innerHTML = `
            <span class="platform-status-dot"></span>
            <span>${platform.name}</span>
        `;

        container.appendChild(badge);
    });

    // Add "manage" button
    const manageBtn = document.createElement('span');
    manageBtn.className = 'platform-badge inactive';
    manageBtn.innerHTML = '+';
    manageBtn.title = 'Manage platforms';
    manageBtn.onclick = () => showPlatformModal(listingId);
    container.appendChild(manageBtn);
}

function showPlatformModal(listingId) {
    const modal = document.getElementById('platform-modal');
    if (!modal) {
        createPlatformModal(listingId);
    } else {
        loadPlatformDetails(listingId);
        modal.classList.add('active');
    }
}

function createPlatformModal(listingId) {
    const modal = document.createElement('div');
    modal.id = 'platform-modal';
    modal.className = 'platform-modal';

    modal.innerHTML = `
        <div class="platform-modal-content">
            <div class="modal-header">
                <h3>Platform Status</h3>
                <button class="modal-close" onclick="closePlatformModal()">&times;</button>
            </div>
            <div id="platform-details-list">
                <p>Loading...</p>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    loadPlatformDetails(listingId);
    modal.classList.add('active');
}

function loadPlatformDetails(listingId) {
    fetch(`/api/listing/${listingId}/platforms`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderPlatformDetails(data.platforms, listingId);
            }
        })
        .catch(error => console.error('Error loading platform details:', error));
}

function renderPlatformDetails(platforms, listingId) {
    const container = document.getElementById('platform-details-list');
    if (!container) return;

    const html = `
        <ul class="platform-list">
            ${platforms.map(platform => `
                <li class="platform-list-item">
                    <div>
                        <strong>${platform.name}</strong>
                        <div style="font-size: 0.85em; color: #666;">
                            Status: ${platform.status}
                            ${platform.listing_id ? `<br>ID: ${platform.listing_id}` : ''}
                        </div>
                    </div>
                    <div class="platform-actions">
                        ${platform.status === 'inactive' || platform.status === 'draft' ?
                            `<button class="btn-sm btn-publish" onclick="publishToPlatform(${listingId}, '${platform.name}')">Publish</button>` :
                            `<button class="btn-sm btn-delist" onclick="delistFromPlatform(${listingId}, '${platform.name}')">Delist</button>`
                        }
                    </div>
                </li>
            `).join('')}
        </ul>
    `;

    container.innerHTML = html;
}

function closePlatformModal() {
    const modal = document.getElementById('platform-modal');
    if (modal) {
        modal.classList.remove('active');
    }
}

async function publishToPlatform(listingId, platform) {
    try {
        const response = await fetch(`/api/listing/${listingId}/publish-to-platform`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ platform })
        });

        const data = await response.json();

        if (data.success) {
            alert(`Published to ${platform}!`);
            loadPlatformDetails(listingId);
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert(`Failed to publish: ${error.message}`);
    }
}

async function delistFromPlatform(listingId, platform) {
    if (!confirm(`Remove this listing from ${platform}?`)) return;

    try {
        const response = await fetch(`/api/listing/${listingId}/delist-from-platform`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ platform })
        });

        const data = await response.json();

        if (data.success) {
            alert(`Delisted from ${platform}`);
            loadPlatformDetails(listingId);
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert(`Failed to delist: ${error.message}`);
    }
}

// Auto-load platform status for all listings on page
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-listing-platforms]').forEach(element => {
        const listingId = element.dataset.listingId;
        const containerId = element.id;
        if (listingId && containerId) {
            loadPlatformStatus(listingId, containerId);
        }
    });
});
</script>
